generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// USERS
// ==========================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  monitors     Monitor[]
  subscription Subscription?

  @@map("users")
}

// ==========================================
// MONITORS
// ==========================================

model Monitor {
  id        String      @id @default(cuid())
  userId    String
  name      String
  url       String
  type      MonitorType
  interval  Int
  isActive  Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  incidents Incident[]
  checks    Check[]

  @@index([userId])
  @@map("monitors")
}

enum MonitorType {
  HTTP
  HTTPS
  SSL
  DOMAIN
  PING
}

// ==========================================
// CHECKS
// ==========================================

model Check {
  id           String   @id @default(cuid())
  monitorId    String
  status       String
  responseTime Int?
  statusCode   Int?
  checkedAt    DateTime @default(now())

  monitor Monitor @relation(fields: [monitorId], references: [id], onDelete: Cascade)

  @@index([monitorId, checkedAt])
  @@map("checks")
}

// ==========================================
// INCIDENTS
// ==========================================

model Incident {
  id           String          @id @default(cuid())
  monitorId    String
  status       IncidentStatus
  startedAt    DateTime        @default(now())
  resolvedAt   DateTime?
  responseTime Int?
  statusCode   Int?
  errorMessage String?

  monitor Monitor @relation(fields: [monitorId], references: [id], onDelete: Cascade)

  @@index([monitorId])
  @@map("incidents")
}

enum IncidentStatus {
  DOWN
  UP
  DEGRADED
}

// ==========================================
// SUBSCRIPTIONS
// ==========================================

model Subscription {
  id        String             @id @default(cuid())
  userId    String             @unique
  plan      Plan               @default(FREE)
  status    SubscriptionStatus @default(ACTIVE)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

enum Plan {
  FREE
  STARTER
  PRO
  BUSINESS
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
}